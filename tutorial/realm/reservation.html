<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Realm Reservation &#8211; Legion Programming System</title>
<meta name="description" content="">

<meta name="keywords" content="Mermaid">


<!-- mermaid Graph -->

  <script type="text/javascript"
  src="https://unpkg.com/mermaid@8.0.0-rc.8/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Realm Reservation">
<meta property="og:description" content="Home page for the Legion parallel programming system">
<meta property="og:url" content="/tutorial/realm/reservation.html">
<meta property="og:site_name" content="Legion Programming System">





<link rel="canonical" href="/tutorial/realm/reservation.html">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Legion Programming System Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='https://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<link rel="icon" sizes="16x16" href="/images/favicon/favicon-16x16.png">
<link rel="icon" sizes="32x32" href="/images/favicon/favicon-32x32.png">
<link rel="icon" sizes="48x48" href="/images/favicon/favicon-48x48.png">
<link rel="icon" sizes="96x96" href="/images/favicon/favicon-96x96.png">
<link rel="icon" sizes="144x144" href="/images/favicon/favicon-144x144.png">
<link rel="icon" sizes="192x192" href="/images/favicon/favicon-192x192.png">
<link rel="apple-touch-icon" sizes="57x57" href="/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png">
<link rel="apple-touch-icon-precomposed" sizes="192x192" href="/images/favicon/apple-icon-precomposed.png">
<meta name="msapplication-config" content="/images/favicon/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<link rel="manifest" href="/images/favicon/manifest.json">

</head>

<body class="page" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">Legion Programming System</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="/overview/" >Overview</a></li>
		        
				<li><a href="/starting/" >Getting Started</a></li>
		        
				<li><a href="/tutorial/" >Tutorials</a></li>
		        
				<li><a href="/events/" >Events</a></li>
		        
				<li><a href="/documentation/" >Documentation</a></li>
		        
				<li><a href="/publications/" >Publications</a></li>
		        
				<li><a href="/resources/" >Resources</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main"  itemprop="mainContentOfPage">
  <div class="article-author-side">
    <a href="https://www.stanford.edu/"><img src="/images/logos/stanford.png" class="bio-photo" alt="Stanford University logo"></a>
<a href="https://www6.slac.stanford.edu/"><img src="/images/logos/slac.jpg" class="bio-photo" alt="SLAC National Accelerator Laboratory logo"></a>
<a href="https://www.lanl.gov/"><img src="/images/logos/los-alamos.png" class="bio-photo" alt="Los Alamos National Laboratory logo"></a>
<a href="https://www.nvidia.com/"><img src="/images/logos/nvidia.png" class="bio-photo" alt="NVIDIA logo"></a>
<a href="https://www.rdworldonline.com/rd-100-award-winners-announced-in-analytical-test-it-electrical-categories/"><img src="/images/logos/rd100.png" class="bio-photo" alt="Winner of the R&D 100 Award"></a>

<h3>Legion</h3>
<p>A Data-Centric Parallel Programming System</p>





<a href="http://github.com/StanfordLegion/legion" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>



  </div>
  <article itemscope itemtype="http://schema.org/CreativeWork">
    <h1 itemprop="name">Realm Reservation</h1>
    <div class="article-wrap" itemprop="text">
      <h2 id="introduction">Introduction</h2>

<p>In parallel programming, atomicity refers to the property of an indivisible and uninterruptible operation.
There are many primitives for guaranteeing atomicity, such as read/writer locks, 
semaphores, mutex, etc. However, they all block execution, which we always want to avoid.
We need a way to ensure that two or more parallel operations can 
guarantee atomicity without specifying ordering using event preconditions.</p>

<p>Realm provides <code class="language-plaintext highlighter-rouge">Reservation</code>, an atomicity primitive that operates in 
a deferred execution manner without blocking.
Reservations also work in distributed memory environments across processes.
In this tutorial, we will walk through an example of
using reservations. There are two types of tasks in the example:
<code class="language-plaintext highlighter-rouge">WRITER_TASK</code> updates the data of an instance, while
<code class="language-plaintext highlighter-rouge">READER_TASK</code> only reads the instance. Only one writer task can
hold ownership of the instance at a time, but multiple 
reader tasks can access the instance concurrently.</p>

<p>Here is a list of covered topics:</p>

<ul>
  <li><a href="#creating-reservations">Creating Reservations</a></li>
  <li><a href="#mutually-exclusive-access">Mutually Exclusive Access</a></li>
  <li><a href="#shared-access">Shared Access</a></li>
  <li><a href="#limitations">Limitations</a></li>
</ul>

<h2 id="creating-reservations">Creating Reservations</h2>

<p>We create a reservation to protect the shared region instance that is accessed
by both reader and writer tasks.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Reservation</span> <span class="n">reservation</span> <span class="o">=</span> <span class="n">Reservation</span><span class="o">::</span><span class="n">create_reservation</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="mutually-exclusive-access">Mutually Exclusive Access</h2>

<p>In this example, we launch multiple writer tasks, each of which reads
the shared region instance and add its index id into the instance, as shown in the <code class="language-plaintext highlighter-rouge">writer_inner_task</code>.
We use the <code class="language-plaintext highlighter-rouge">acquire</code> and <code class="language-plaintext highlighter-rouge">release</code> methods to ensure exclusive write access to the shared region instance.</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Event</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">reservation</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="mi">0</span> <span class="cm">/* mode */</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* exclusive */</span><span class="p">,</span> <span class="n">start_event</span> <span class="cm">/* wait on */</span><span class="p">);</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">cpus</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">cpus</span><span class="p">.</span><span class="n">size</span><span class="p">()].</span><span class="n">spawn</span><span class="p">(</span><span class="n">WRITER_TASK1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WriterTaskArgs</span><span class="p">),</span> <span class="n">e1</span><span class="p">);</span>
<span class="n">reservation</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</code></pre></div></div>
<p>The execution of <code class="language-plaintext highlighter-rouge">acquire</code> is deferred until all preconditions are satisfied. 
The method returns an event that is used as the precondition
of the corresponding writer task. The reservation is then released after each writer task exits, allowing for the next writer to acquire the reservation.
These two methods ensure that one writer task can be executed at a time, 
thereby preventing conflicts among multiple writers.</p>

<p>As mentioned before, a reservation can be used as a global lock across processes.
In this example, when <code class="language-plaintext highlighter-rouge">TestConfig::distributed_reservation</code> is set to true, 
we try to use the reservation inside <code class="language-plaintext highlighter-rouge">writer_task2</code> as a global lock. 
Like <code class="language-plaintext highlighter-rouge">Event</code>, a reservation can be passed into local/remote tasks 
via task argument. Inside <code class="language-plaintext highlighter-rouge">writer_task2</code>, we can use the <code class="language-plaintext highlighter-rouge">acquire</code> 
and <code class="language-plaintext highlighter-rouge">release</code> methods to ensure that only one <code class="language-plaintext highlighter-rouge">writer_inner_task</code> is executed at a time.</p>

<h2 id="shared-access">Shared Access</h2>

<p>After the writer tasks update the shared instance,
we launch multiple reader tasks to read data from the region instance, as shown in <code class="language-plaintext highlighter-rouge">reader_task</code>. 
Usually, it is not necessary to use a reservation to protect reader tasks
because all writer tasks have already been finished. However, to demonstrate the use of shared ownership 
of the reservation, we also launch a writer task concurrently with the reader tasks.
To acquire the shared ownership of the reservation, we can pass 
<code class="language-plaintext highlighter-rouge">mode=1, exclusive=false</code> to the acquire method.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Event</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">reservation</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="mi">1</span> <span class="cm">/* mode */</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/* exclusive */</span><span class="p">,</span> <span class="n">writer_event</span> <span class="cm">/* wait on */</span><span class="p">);</span>
<span class="n">Event</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">cpus</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">cpus</span><span class="p">.</span><span class="n">size</span><span class="p">()].</span><span class="n">spawn</span><span class="p">(</span><span class="n">READER_TASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ReaderTaskArgs</span><span class="p">),</span> <span class="n">e1</span><span class="p">);</span>
<span class="n">reservation</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>
</code></pre></div></div>

<p>It is worth mentioning that <code class="language-plaintext highlighter-rouge">mode=0</code> indicates exclusive ownership, 
so we need to set the mode to a different number to obtain shared ownership.</p>

<h2 id="limitations">Limitations</h2>

<p>There are several limitations when using a reservation.</p>

<ul>
  <li>Currently, Realm does not allow multiple nodes to hold a reservation 
simultaneously. Therefore, acquiring a reservation in shared mode on different nodes is impossible.</li>
  <li>If multiple reservations need to be acquired, they must be acquired in 
a specific order to avoid deadlock, similar to how normal locks are acquired.</li>
  <li>Realm is not obligated to grant reservations in any specific order. 
For example, in the following code:</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Launch task 1</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">reservation</span><span class="p">.</span><span class="n">acquire</span><span class="p">();</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">TASK1</span><span class="p">,</span> <span class="n">e1</span><span class="p">);</span>
<span class="n">reservation</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>
<span class="c1">// Launch task 2</span>
<span class="n">e3</span> <span class="o">=</span> <span class="n">reservation</span><span class="p">.</span><span class="n">acquire</span><span class="p">();</span>
<span class="n">e4</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">);</span>
<span class="n">e5</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">TASK2</span><span class="p">,</span> <span class="n">e4</span><span class="p">);</span>
<span class="n">reservation</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">e5</span><span class="p">);</span>
</code></pre></div></div>

<p>A corresponding sequence diagram is shown below:</p>

<div class="mermaid">
    graph TD
    A{acquire} --&gt; B{TASK1}
    B --&gt; C{release}
    D{acquire} --&gt; E{TASK2}
    B --&gt; E
    E --&gt; F{release}
</div>

<p>It is possible for the reservation e3 to be granted before the reservation e1, 
resulting in a deadlock because the second task launch 
will not run until the first task launch is done. Instead, the second acquire can wait on e2 rather than in the copy, thus forcing a proper total order free of deadlocks.</p>

    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#index -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2024 Legion. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-20524102-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

          

</body>
</html>
